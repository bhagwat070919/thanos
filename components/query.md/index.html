<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content=noodp><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css integrity=sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.1/css/all.css integrity=sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr crossorigin=anonymous><link rel=stylesheet href=https://improbable-eng.github.io/thanos/main.css><link rel=stylesheet href=https://improbable-eng.github.io/thanos/syntax.css><link rel=icon href=https://improbable-eng.github.io/thanos/icon-light.png><title>Thanos - Highly available Prometheus setup with long term storage capabilities</title><meta property=og:image content=/icon-light.png><meta property=og:type content=object><meta property=og:title content=Thanos><meta property=og:description content="Thanos - Highly available Prometheus setup with long term storage capabilities"></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-purple"><a href=https://improbable-eng.github.io/thanos/ class=navbar-brand><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt="Thanos logo"> Thanos</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://improbable-eng.github.io/thanos/getting-started.md>Documentation</a></li><li class=nav-item><a class=nav-link href=https://github.com/improbable-eng/thanos/releases>Download</a></li><li class=nav-item><a href=https://github.com/improbable-eng/thanos class=nav-link><i class="fab fa-fw fa-github"></i>GitHub</a></li><li class=nav-item><a href=https://twitter.com/ThanosMetrics class=nav-link><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div></nav><div class=container><div class="row py-3 py-lg-5"><div class="col-12 col-lg-3"><button class="btn btn-block btn-outline-secondary mb-3 d-block d-lg-none" type=button data-toggle=collapse data-target=.docs-menu>
Toggle Menu</button><nav class="docs-menu collapse d-lg-block"><h5>Thanos</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/getting-started.md/>Getting Started</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/changelog/>Changelog</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/design.md/>Design</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/storage.md/>Object Storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/service-discovery.md/>Service Discovery</a></div><h5 class=mt-3>Components</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/bucket.md/>Bucket</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/compact.md/>Compact</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/query.md/>Query</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/rule.md/>Rule</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/sidecar.md/>Sidecar</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/store.md/>Store</a></div><h5 class=mt-3>Contributing</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/code_of_conduct/>Code of Conduct</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/how-to-contribute-to-docs.md/>Contribute to docs</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/>Contributing</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/dev.md/>Troubleshooting for dev workflow</a></div><h5 class=mt-3>Proposals</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201809_gossip-removal.md/>Deprecated gossip clustering in favor of File SD</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201807_store_instance_high_availability.md/>High-availability for store instances</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201901-read-write-operations-bucket.md/>Read-Write coordination free operational contract for object storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/config.md/>Thanos Cluster Configuration</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201812_thanos-remote-receive.md/>Thanos Remote Write</a></div></nav></div><div class="col-12 col-lg-9"><h1 id=query>Query</h1><p>The query component implements the Prometheus HTTP v1 API to query data in a Thanos cluster via PromQL.</p><p>It gathers the data needed to evaluate the query from underlying StoreAPIs. See <a href=../../service-discovery.md>here</a>
on how to connect querier with desired StoreAPIs.</p><p>Querier currently is fully stateless and horizontally scalable.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ thanos query <span class=se>\
</span><span class=se></span>    --http-address     <span class=s2>&#34;0.0.0.0:9090&#34;</span> <span class=se>\
</span><span class=se></span>    --store            <span class=s2>&#34;&lt;store-api&gt;:&lt;grpc-port&gt;&#34;</span> <span class=se>\
</span><span class=se></span>    --store            <span class=s2>&#34;&lt;store-api2&gt;:&lt;grpc-port&gt;&#34;</span> <span class=err>\</span></code></pre></div><h2 id=deduplication>Deduplication</h2><p>The query layer can deduplicate series that were collected from high-availability pairs of data sources such as Prometheus.
A fixed replica label must be chosen for the entire cluster and can then be passed to query nodes on startup.</p><p>Two or more series that have that are only distinguished by the given replica label, will be merged into a single time series.
This also hides gaps in collection of a single data source. For example:</p><ul><li>Prometheus + sidecar &ldquo;A&rdquo;: <code>cluster=1,env=2,replica=A</code></li><li>Prometheus + sidecar &ldquo;B&rdquo;: <code>cluster=1,env=2,replica=B</code></li><li>Prometheus + sidecar &ldquo;A&rdquo; in different cluster: <code>cluster=2,env=2,replica=A</code></li></ul><p>If we configure Querier like this:</p><pre><code>$ thanos query \
    --http-address        &quot;0.0.0.0:9090&quot; \
    --query.replica-label &quot;replica&quot; \
    --store               &quot;&lt;store-api&gt;:&lt;grpc-port&gt;&quot; \
    --store               &quot;&lt;store-api2&gt;:&lt;grpc-port&gt;&quot; \
</code></pre><p>And we query for metric <code>up{job=&quot;prometheus&quot;,env=&quot;2&quot;}</code> with this option we will get 2 results:</p><ul><li><code>up{job=&quot;prometheus&quot;,env=&quot;2&quot;,cluster=&quot;1&quot;} 1</code></li><li><code>up{job=&quot;prometheus&quot;,env=&quot;2&quot;,cluster=&quot;2&quot;} 1</code></li></ul><p>WITHOUT this replica flag (so deduplication turned off), we will get 3 results:</p><ul><li><code>up{job=&quot;prometheus&quot;,env=&quot;2&quot;,cluster=&quot;1&quot;,replica=&quot;A&quot;} 1</code></li><li><code>up{job=&quot;prometheus&quot;,env=&quot;2&quot;,cluster=&quot;1&quot;,replica=&quot;B&quot;} 1</code></li><li><code>up{job=&quot;prometheus&quot;,env=&quot;2&quot;,cluster=&quot;2&quot;,replica=&quot;A&quot;} 1</code></li></ul><p>This logic can also be controlled via parameter on QueryAPI. More details below.</p><h2 id=query-api>Query API</h2><p>Overall QueryAPI exposed by Thanos is guaranteed to be compatible with Prometheus 2.x.</p><p>However, for additional Thanos features, Thanos, on top of Prometheus adds several
additional parameters listed below as well as custom response fields.</p><h3 id=deduplication-enabled>Deduplication Enabled</h3><table class="table table-striped"><thead><tr><th>HTTP URL/FORM parameter</th><th>Type</th><th>Default</th><th>Example</th></tr></thead><tbody><tr><td><code>dedup</code></td><td><code>Boolean</code></td><td>True, but effect depends on <code>query.replica</code> configuration flag.</td><td><code>1, t, T, TRUE, true, True</code> for &ldquo;True&rdquo;</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p>This controls if query should use <code>replica</code> label for deduplication or not.</p><h3 id=auto-downsampling>Auto downsampling</h3><table class="table table-striped"><thead><tr><th>HTTP URL/FORM parameter</th><th>Type</th><th>Default</th><th>Example</th></tr></thead><tbody><tr><td><code>max_source_resolution</code></td><td><code>Float64/time.Duration/model.Duration</code></td><td><code>step / 5</code> or <code>0</code> if <code>query.auto-downsampling</code> is false (default: False)</td><td><code>5m</code></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p>Max source resolution is max resolution in seconds we want to use for data we query for. This means that for value:
* 0 -&gt; we will use only raw data.
* 5m -&gt; we will use max 5m downsampling.
* 1h -&gt; we will use max 1h downsampling.</p><h3 id=partial-response-error-enabled>Partial Response / Error Enabled</h3><table class="table table-striped"><thead><tr><th>HTTP URL/FORM parameter</th><th>Type</th><th>Default</th><th>Example</th></tr></thead><tbody><tr><td><code>partial_response</code></td><td><code>Boolean</code></td><td><code>query.partial-response</code> flag (default: True)</td><td><code>1, t, T, TRUE, true, True</code> for &ldquo;True&rdquo;</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p>If true, then all storeAPIs that will be unavailable (and thus return no data) will not cause query to fail, but instead
return warning.</p><h3 id=custom-response-fields>Custom Response Fields</h3><p>Any additional field does not break compatibility, however there is no guarantee that Grafana or any other client will understand those.</p><p>Currently Thanos UI exposed by Thanos understands</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>queryData</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>ResultType</span> <span class=nx>promql</span><span class=p>.</span><span class=nx>ValueType</span> <span class=s>`json:&#34;resultType&#34;`</span>
	<span class=nx>Result</span>     <span class=nx>promql</span><span class=p>.</span><span class=nx>Value</span>     <span class=s>`json:&#34;result&#34;`</span>

	<span class=c1>// Additional Thanos Response field.
</span><span class=c1></span>	<span class=nx>Warnings</span>   <span class=p>[]</span><span class=kt>error</span>          <span class=s>`json:&#34;warnings,omitempty&#34;`</span>
<span class=p>}</span></code></pre></div><p>Additional field is <code>Warnings</code> that contains every error that occurred that is assumed non critical. <code>partial_response</code>
option controls if storeAPI unavailability is considered critical.</p><h2 id=expose-ui-on-a-sub-path>Expose UI on a sub-path</h2><p>It is possible to expose thanos-query UI and optionally API on a sub-path.
The sub-path can be defined either statically or dynamically via an HTTP header.
Static path prefix definition follows the pattern used in Prometheus,
where <code>web.route-prefix</code> option defines HTTP request path prefix (endpoints prefix)
and <code>web.external-prefix</code> prefixes the URLs in HTML code and the HTTP redirect responces.</p><p>Additionally, Thanos supports dynamic prefix configuration, which
<a href=https://github.com/prometheus/prometheus/issues/3156>is not yet implemented by Prometheus</a>.
Dynamic prefixing simplifies setup when <code>thanos query</code> is exposed on a sub-path behind
a reverse proxy, for example, via a Kubernetes ingress controller
<a href=https://docs.traefik.io/basics/#frontends>Traefik</a>
or <a href=https://github.com/kubernetes/ingress-nginx/pull/1805>nginx</a>.
If <code>PathPrefixStrip: /some-path</code> option or <code>traefik.frontend.rule.type: PathPrefixStrip</code>
Kubernetes Ingress annotation is set, then <code>Traefik</code> writes the stripped prefix into X-Forwarded-Prefix header.
Then, <code>thanos query --web.prefix-header=X-Forwarded-Prefix</code> will serve correct HTTP redirects and links prefixed by the stripped path.</p><h2 id=flags>Flags</h2><div class=highlight><pre class=chroma><code class=language-$ data-lang=$>usage: thanos query [&lt;flags&gt;]

query node exposing PromQL enabled Query API with data retrieved from multiple
store nodes

Flags:
  -h, --help                     Show context-sensitive help (also try
                                 --help-long and --help-man).
      --version                  Show application version.
      --log.level=info           Log filtering level.
      --log.format=logfmt        Log format to use.
      --gcloudtrace.project=GCLOUDTRACE.PROJECT
                                 GCP project to send Google Cloud Trace tracings
                                 to. If empty, tracing will be disabled.
      --gcloudtrace.sample-factor=1
                                 How often we send traces (1/&lt;sample-factor&gt;).
                                 If 0 no trace will be sent periodically, unless
                                 forced by baggage item. See
                                 `pkg/tracing/tracing.go` for details.
      --http-address=&#34;0.0.0.0:10902&#34;
                                 Listen host:port for HTTP endpoints.
      --grpc-address=&#34;0.0.0.0:10901&#34;
                                 Listen ip:port address for gRPC endpoints
                                 (StoreAPI). Make sure this address is routable
                                 from other components if you use gossip,
                                 &#39;grpc-advertise-address&#39; is empty and you
                                 require cross-node connection.
      --grpc-server-tls-cert=&#34;&#34;  TLS Certificate for gRPC server, leave blank to
                                 disable TLS
      --grpc-server-tls-key=&#34;&#34;   TLS Key for the gRPC server, leave blank to
                                 disable TLS
      --grpc-server-tls-client-ca=&#34;&#34;
                                 TLS CA to verify clients against. If no client
                                 CA is specified, there is no client
                                 verification on server side. (tls.NoClientCert)
      --grpc-advertise-address=GRPC-ADVERTISE-ADDRESS
                                 Explicit (external) host:port address to
                                 advertise for gRPC StoreAPI in gossip cluster.
                                 If empty, &#39;grpc-address&#39; will be used.
      --cluster.address=&#34;0.0.0.0:10900&#34;
                                 Listen ip:port address for gossip cluster.
      --cluster.advertise-address=CLUSTER.ADVERTISE-ADDRESS
                                 Explicit (external) ip:port address to
                                 advertise for gossip in gossip cluster. Used
                                 internally for membership only.
      --cluster.peers=CLUSTER.PEERS ...
                                 Initial peers to join the cluster. It can be
                                 either &lt;ip:port&gt;, or &lt;domain:port&gt;. A lookup
                                 resolution is done only at the startup.
      --cluster.gossip-interval=&lt;gossip interval&gt;
                                 Interval between sending gossip messages. By
                                 lowering this value (more frequent) gossip
                                 messages are propagated across the cluster more
                                 quickly at the expense of increased bandwidth.
                                 Default is used from a specified network-type.
      --cluster.pushpull-interval=&lt;push-pull interval&gt;
                                 Interval for gossip state syncs. Setting this
                                 interval lower (more frequent) will increase
                                 convergence speeds across larger clusters at
                                 the expense of increased bandwidth usage.
                                 Default is used from a specified network-type.
      --cluster.refresh-interval=1m
                                 Interval for membership to refresh
                                 cluster.peers state, 0 disables refresh.
      --cluster.secret-key=CLUSTER.SECRET-KEY
                                 Initial secret key to encrypt cluster gossip.
                                 Can be one of AES-128, AES-192, or AES-256 in
                                 hexadecimal format.
      --cluster.network-type=lan
                                 Network type with predefined peers
                                 configurations. Sets of configurations
                                 accounting the latency differences between
                                 network types: local, lan, wan.
      --cluster.disable          If true gossip will be disabled and no cluster
                                 related server will be started.
      --http-advertise-address=HTTP-ADVERTISE-ADDRESS
                                 Explicit (external) host:port address to
                                 advertise for HTTP QueryAPI in gossip cluster.
                                 If empty, &#39;http-address&#39; will be used.
      --grpc-client-tls-secure   Use TLS when talking to the gRPC server
      --grpc-client-tls-cert=&#34;&#34;  TLS Certificates to use to identify this client
                                 to the server
      --grpc-client-tls-key=&#34;&#34;   TLS Key for the client&#39;s certificate
      --grpc-client-tls-ca=&#34;&#34;    TLS CA Certificates to use to verify gRPC
                                 servers
      --grpc-client-server-name=&#34;&#34;
                                 Server name to verify the hostname on the
                                 returned gRPC certificates. See
                                 https://tools.ietf.org/html/rfc4366#section-3.1
      --web.route-prefix=&#34;&#34;      Prefix for API and UI endpoints. This allows
                                 thanos UI to be served on a sub-path. This
                                 option is analogous to --web.route-prefix of
                                 Promethus.
      --web.external-prefix=&#34;&#34;   Static prefix for all HTML links and redirect
                                 URLs in the UI query web interface. Actual
                                 endpoints are still served on / or the
                                 web.route-prefix. This allows thanos UI to be
                                 served behind a reverse proxy that strips a URL
                                 sub-path.
      --web.prefix-header=&#34;&#34;     Name of HTTP request header used for dynamic
                                 prefixing of UI links and redirects. This
                                 option is ignored if web.external-prefix
                                 argument is set. Security risk: enable this
                                 option only if a reverse proxy in front of
                                 thanos is resetting the header. The
                                 --web.prefix-header=X-Forwarded-Prefix option
                                 can be useful, for example, if Thanos UI is
                                 served via Traefik reverse proxy with
                                 PathPrefixStrip option enabled, which sends the
                                 stripped prefix value in X-Forwarded-Prefix
                                 header. This allows thanos UI to be served on a
                                 sub-path.
      --query.timeout=2m         Maximum time to process query by query node.
      --query.max-concurrent=20  Maximum number of queries processed
                                 concurrently by query node.
      --query.replica-label=QUERY.REPLICA-LABEL
                                 Label to treat as a replica indicator along
                                 which data is deduplicated. Still you will be
                                 able to query without deduplication using
                                 &#39;dedup=false&#39; parameter.
      --selector-label=&lt;name&gt;=&#34;&lt;value&gt;&#34; ...
                                 Query selector labels that will be exposed in
                                 info endpoint (repeated).
      --store=&lt;store&gt; ...        Addresses of statically configured store API
                                 servers (repeatable). The scheme may be
                                 prefixed with &#39;dns+&#39; or &#39;dnssrv+&#39; to detect
                                 store API servers through respective DNS
                                 lookups.
      --store.sd-files=&lt;path&gt; ...
                                 Path to files that contain addresses of store
                                 API servers. The path can be a glob pattern
                                 (repeatable).
      --store.sd-interval=5m     Refresh interval to re-read file SD files. It
                                 is used as a resync fallback.
      --store.sd-dns-interval=30s
                                 Interval between DNS resolutions.
      --query.auto-downsampling  Enable automatic adjustment (step / 5) to what
                                 source of data should be used in store gateways
                                 if no max_source_resolution param is specified.
      --query.partial-response   Enable partial response for queries if no
                                 partial_response param is specified.
      --store.response-timeout=0ms
                                 If a Store doesn&#39;t send any data in this
                                 specified duration then a Store will be ignored
                                 and partial data will be returned if it&#39;s
                                 enabled. 0 disables timeout.</code></pre></div></div></div></div><footer class="bg-dark text-light"><div class="container text-center text-md-left"><div class="row py-5"><div class="col-12 col-md-6 col-lg mb-3 mb-lg-0"><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt=Thanos width=45%></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Documentation</h6><ul class=list-unstyled><li><a class=text-reset href=https://improbable-eng.github.io/thanos/getting-started.md>Getting Started</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/design.md>Design</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/storage.md>Storage</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/service-discovery.md>Service Discovery</a></li></ul></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://join.slack.com/t/improbable-eng/shared_invite/enQtMzQ1ODcyMzQ5MjM4LWY5ZWZmNGM2ODc5MmViNmQ3ZTA3ZTY3NzQwOTBlMTkzZmIxZTIxODk0OWU3YjZhNWVlNDU3MDlkZGViZjhkMjc class=text-reset><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/improbable-eng/thanos class=text-reset><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/ThanosMetrics class=text-reset><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col col-md-6 col-lg"><h6 class=font-weight-bold>About</h6><p>Thanos is an OSS licensed project as Apache License 2.0</p></div></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js integrity=sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-137374921-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>