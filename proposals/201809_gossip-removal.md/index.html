<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content=noodp><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css integrity=sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.1/css/all.css integrity=sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr crossorigin=anonymous><link rel=stylesheet href=https://improbable-eng.github.io/thanos/main.css><link rel=stylesheet href=https://improbable-eng.github.io/thanos/syntax.css><link rel=icon href=https://improbable-eng.github.io/thanos/icon-light.png><title>Thanos - Highly available Prometheus setup with long term storage capabilities</title><meta property=og:image content=/icon-light.png><meta property=og:type content=object><meta property=og:title content=Thanos><meta property=og:description content="Thanos - Highly available Prometheus setup with long term storage capabilities"></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-purple"><a href=https://improbable-eng.github.io/thanos/ class=navbar-brand><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt="Thanos logo"> Thanos</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://improbable-eng.github.io/thanos/getting-started.md>Documentation</a></li><li class=nav-item><a class=nav-link href=https://github.com/improbable-eng/thanos/releases>Download</a></li><li class=nav-item><a href=https://github.com/improbable-eng/thanos class=nav-link><i class="fab fa-fw fa-github"></i>GitHub</a></li><li class=nav-item><a href=https://twitter.com/ThanosMetrics class=nav-link><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div></nav><div class=container><div class="row py-5"><div class="col col-3"><button class="btn btn-block btn-outline-secondary mb-3 d-block d-lg-none" type=button data-toggle=collapse data-target=.docs-menu>
Toggle Menu</button><nav class="docs-menu collapse d-lg-block"><h5>Thanos</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/getting-started.md/>&nbsp;&nbsp;&nbsp;&nbsp;Getting Started</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/changelog/>&nbsp;&nbsp;&nbsp;&nbsp;Changelog</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/design.md/>&nbsp;&nbsp;&nbsp;&nbsp;Design</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/storage.md/>&nbsp;&nbsp;&nbsp;&nbsp;Object Storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/service-discovery.md/>&nbsp;&nbsp;&nbsp;&nbsp;Service Discovery</a></div><h5 class=mt-3>Components</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/bucket.md/>&nbsp;&nbsp;&nbsp;&nbsp;Bucket</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/compact.md/>&nbsp;&nbsp;&nbsp;&nbsp;Compact</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/query.md/>&nbsp;&nbsp;&nbsp;&nbsp;Query</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/rule.md/>&nbsp;&nbsp;&nbsp;&nbsp;Rule</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/sidecar.md/>&nbsp;&nbsp;&nbsp;&nbsp;Sidecar</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/store.md/>&nbsp;&nbsp;&nbsp;&nbsp;Store</a></div><h5 class=mt-3>Contributing</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/code_of_conduct/>&nbsp;&nbsp;&nbsp;&nbsp;Code of Conduct</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/how-to-contribute-to-docs.md/>&nbsp;&nbsp;&nbsp;&nbsp;Contribute to docs</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/>&nbsp;&nbsp;&nbsp;&nbsp;Contributing</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/dev.md/>&nbsp;&nbsp;&nbsp;&nbsp;Troubleshooting for dev workflow</a></div><h5 class=mt-3>Proposals</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201809_gossip-removal.md/>&nbsp;&nbsp;&nbsp;&nbsp;Deprecated gossip clustering in favor of File SD</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201807_store_instance_high_availability.md/>&nbsp;&nbsp;&nbsp;&nbsp;High-availability for store instances</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201901-read-write-operations-bucket.md/>&nbsp;&nbsp;&nbsp;&nbsp;Read-Write coordination free operational contract for object storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/config.md/>&nbsp;&nbsp;&nbsp;&nbsp;Thanos Cluster Configuration</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201812_thanos-remote-receive.md/>&nbsp;&nbsp;&nbsp;&nbsp;Thanos Remote Write</a></div></nav></div><div class="col col-9"><h1>Deprecated gossip clustering in favor of File SD</h1><dl><dt>Status</dt><dd><span class="badge badge-success">accepted</span></dd><dt>Owner</dt><dd><a href=https://github.com/bwplotka>@bwplotka</a></dd></dl><h3 id=ticket-https-github-com-improbable-eng-thanos-issues-484>Ticket: <a href=https://github.com/improbable-eng/thanos/issues/484>https://github.com/improbable-eng/thanos/issues/484</a></h3><h2 id=summary>Summary</h2><p>It is becoming clear that we need to remove gossip protocol as our main way of communication between Thanos Querier and
other components. Static configuration seems to be well enough for our simple use cases. To give users more flexibility
(similar to gossip auto-join logic), we already wanted to introduce a <a href=https://github.com/improbable-eng/thanos/issues/492>File SD</a>
that allows changing <code>StoreAPI</code>s on-the-fly.</p><h2 id=motivation>Motivation</h2><p><a href=https://en.wikipedia.org/wiki/Gossip_protocol>Gossip</a> protocol (with the <a href=https://github.com/hashicorp/memberlist>membership</a> implementation)
was built into Thanos from the very beginning. The main advantages over other solution to connect components were:
* Auto-join and auto-drop of components based on health checks.
* Propagation of tiny metadata.</p><p>After a couple of month of maintaining Thanos project and various discussions with different users, we realized that those advantages
are not outstanding anymore and are not worth keeping, compared to the issues gossip causes. There are numerous reasons why we should
deprecate gossip:
* Gossip has been proven to be extremely confusing for the new users. Peer logic and really confusing <code>cluster.advertise-address</code> that
was sometimes able to magically deduce private IP address (and sometimes not!) were leading to lots of questions and issues.
Something that was made for quick ramp-up into Thanos (&ldquo;just click the button and it auto-joins everything&rdquo;) created lots of confusion
and made it harder to experiment.
* Auto-join logic has its price. All peers connected were aware of each other. All were included in metadata propagation.
Membership project community made an awesome job to optimize N^N communication (all-to-all), but nevertheless, it is something
that is totally unnecessary to Thanos. And it led to wrong assumptions that e.g sidecar needs to be aware of another sidecar etc.
<em>Thanos Querier is the only component that requires to be aware of other <code>StoreAPI</code>s</em>. It is clear that <code>all-to-all</code> communication is
neither necessary nor educative.
* Unless specifically configured (which requires advanced knowledge) Gossip uses mix of TCP and UPD underneath its
custom app level protocol. This is a no-go if you use L7 loadbalancers and proxies.
* Global gossip is really difficult to achieve. BTW, If you know how to setup this, please write a blog about it! (:
* With the addition of the simplest possible solution to give Thanos Querier knowledge where are <code>StoreAPI</code>s (static <code>--store</code> flag),
we needed to implement health check and metadata propagation anyway. In fact, <code>StoreAPI.Info</code> was already there all the time.
* Gossip operates per <code>peer</code> level and there is no way you can abstract multiple peers behind loadbalancer. This hides easy
solutions from our eyes, e.g how to make Store Gateway HA. Without gossip, you can just use Kubernetes HA Service or any other loadbalancer.
To support Store Gateway HA for gossip we would end up implementing LB logic in Thanos Querier (like proposed <a href=https://github.com/improbable-eng/thanos/pull/404>here</a>)
* At some point we want to be flexible and allow other discovery mechanisms. Gossip does not work for everyone and static flags
are too.. static. (: We need <a href=https://github.com/improbable-eng/thanos/issues/492>File SD</a> for flexibility anyway.
* One thing less to maintain.</p><h2 id=goals>Goals</h2><ul><li>Remove gossip support from code (Decision after initial feedback)<ul><li>We are still RC, so technically there are no API guarantees yet.</li></ul></li><li>Leave &ndash;store flags</li><li>Make sure <a href=https://github.com/improbable-eng/thanos/issues/492>File SD</a> is in place and documented before removal.</li></ul><h2 id=proposal-steps>Proposal: Steps</h2><ul><li>Add File Service Discovery (SD): <a href=https://github.com/improbable-eng/thanos/issues/492>https://github.com/improbable-eng/thanos/issues/492</a></li><li>Remove gossip from the documentation, be clear what talks with what (!)</li><li>Deprecate gossip in code.</li><li>Remove gossip code and flags AFTER <a href=https://github.com/improbable-eng/thanos/issues/492>File SD</a> is done and stable.</li></ul><h3 id=backwards-compatibility>Backwards compatibility</h3><p><strong>We will break backward compatibility</strong>, as gossip was the main way to connect components. As it is not very nice, it will
ensure stability and better user experience and flexibility in the future. As we are in 0.1.0 RC process, we will not break any guarantee.</p><p>As help for migration we might want to add sidecar that uses FileSD but support gossip clustering.</p><h2 id=alternatives-considered>Alternatives considered</h2><ol><li>Just improve documentation of gossip</li></ol><ul><li>It will not help in efficiency/unnecessary traffic problem</li><li>We will have 2 ways of communication as it is now - hard to maintain and think about.</li></ul><h2 id=related-future-work>Related Future Work</h2><ol><li>Add example sidecars that will provide more sophisticated discovery and integrate with our File SD (e.g k8s SD)</li></ol></div></div></div><footer class="bg-dark text-light"><div class="container text-center text-md-left"><div class="row py-5"><div class="col-12 col-md-6 col-lg mb-3 mb-lg-0"><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt=Thanos width=45%></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Documentation</h6><ul class=list-unstyled><li><a class=text-reset href=https://improbable-eng.github.io/thanos/getting-started.md>Getting Started</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/design.md>Design</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/storage.md>Storage</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/service-discovery.md>Service Discovery</a></li></ul></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://join.slack.com/t/improbable-eng/shared_invite/enQtMzQ1ODcyMzQ5MjM4LWY5ZWZmNGM2ODc5MmViNmQ3ZTA3ZTY3NzQwOTBlMTkzZmIxZTIxODk0OWU3YjZhNWVlNDU3MDlkZGViZjhkMjc class=text-reset><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/improbable-eng/thanos class=text-reset><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/ThanosMetrics class=text-reset><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col col-md-6 col-lg"><h6 class=font-weight-bold>About</h6><p>Thanos is an OSS licensed project as Apache License 2.0</p></div></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js integrity=sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-137374921-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>