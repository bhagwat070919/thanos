<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content=noodp><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css integrity=sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.1/css/all.css integrity=sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr crossorigin=anonymous><link rel=stylesheet href=https://improbable-eng.github.io/thanos/main.css><link rel=stylesheet href=https://improbable-eng.github.io/thanos/syntax.css><link rel=icon href=https://improbable-eng.github.io/thanos/icon-light.png><title>Thanos - Highly available Prometheus setup with long term storage capabilities</title><meta property=og:image content=/icon-light.png><meta property=og:type content=object><meta property=og:title content=Thanos><meta property=og:description content="Thanos - Highly available Prometheus setup with long term storage capabilities"></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-purple"><a href=https://improbable-eng.github.io/thanos/ class=navbar-brand><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt="Thanos logo"> Thanos</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://improbable-eng.github.io/thanos/getting-started.md>Documentation</a></li><li class=nav-item><a class=nav-link href=https://github.com/improbable-eng/thanos/releases>Download</a></li><li class=nav-item><a href=https://github.com/improbable-eng/thanos class=nav-link><i class="fab fa-fw fa-github"></i>GitHub</a></li><li class=nav-item><a href=https://twitter.com/ThanosMetrics class=nav-link><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div></nav><div class=container><div class="row py-5"><div class="col col-3"><button class="btn btn-block btn-outline-secondary mb-3 d-block d-lg-none" type=button data-toggle=collapse data-target=.docs-menu>
Toggle Menu</button><nav class="docs-menu collapse d-lg-block"><h5>Thanos</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/getting-started.md/>Getting Started</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/changelog/>Changelog</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/design.md/>Design</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/storage.md/>Object Storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/service-discovery.md/>Service Discovery</a></div><h5 class=mt-3>Components</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/bucket.md/>Bucket</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/compact.md/>Compact</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/query.md/>Query</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/rule.md/>Rule</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/sidecar.md/>Sidecar</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/store.md/>Store</a></div><h5 class=mt-3>Contributing</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/code_of_conduct/>Code of Conduct</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/how-to-contribute-to-docs.md/>Contribute to docs</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/>Contributing</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/dev.md/>Troubleshooting for dev workflow</a></div><h5 class=mt-3>Proposals</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201809_gossip-removal.md/>Deprecated gossip clustering in favor of File SD</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201807_store_instance_high_availability.md/>High-availability for store instances</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201901-read-write-operations-bucket.md/>Read-Write coordination free operational contract for object storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/config.md/>Thanos Cluster Configuration</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201812_thanos-remote-receive.md/>Thanos Remote Write</a></div></nav></div><div class="col col-9"><h1>High-availability for store instances</h1><dl><dt>Status</dt><dd><span class="badge badge-danger">rejected</span></dd><dt>Owner</dt><dd><a href=https://github.com/mattbostock>@mattbostock</a></dd></dl><h2 id=summary>Summary</h2><p>This proposal makes total sense and solves our goals when using gossip. However there exists a very easy solution
to this problem in form of using just static entry with any loadbalancer like Kubernetes Service to load balance
through different Store Gateways. Those are technically stateless, so request can fetch the data independently.</p><h2 id=motivation>Motivation</h2><p>Thanos store instances currently have no explicit support for
high-availability; query instances treat all store instances equally. If
multiple store instances are used as gateways to a single bucket in an object
store, Thanos query instances will wait for all instances to respond (subject
to timeouts) before returning a response.</p><h2 id=goals>Goals</h2><ul><li><p>Explicitly support and document high availability for store instances.</p></li><li><p>Reduce the query latency incurred by failing store instances when other store
instances could return the same response faster.</p></li></ul><h2 id=proposal>Proposal</h2><p>Thanos supports deduplication of metrics retrieved from multiple Prometheus
servers to avoid gaps in query responses where a single Prometheus server
failed but similar data was recorded by another Prometheus server in the same
failure domain. To support deduplication, Thanos must wait for all Thanos
sidecar servers to return their data (subject to timeouts) before returning a
response to a client.</p><p>When retrieving data from Thanos bucket store instances, however, the desired
behaviour is different; we want Thanos use the first successful response it
receives, on the assumption that all bucket store instances that communicate
with the same bucket have access to the same data.</p><p>To support the desired behaviour for bucket store instances while still
allowing for deduplication, we propose to expand the <a href=https://github.com/improbable-eng/thanos/blob/b67aa3a709062be97215045f7488df67a9af2c66/pkg/store/storepb/rpc.proto#L28-L32>InfoResponse
Protobuf</a>
used by the Store API by adding two fields:</p><ul><li><p>a string identifier that can be used to group store instances</p></li><li><p>an enum representing the <a href=https://github.com/improbable-eng/thanos/blob/673614d9310f3f90fdb4585ca6201496ff92c697/pkg/cluster/cluster.go#L51-L64>peer type as defined in the cluster
package</a></p></li></ul><p>For example;</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- before	2018-07-02 15:49:09.000000000 +0100
</span><span class=gd></span><span class=gi>+++ after	2018-07-02 15:49:13.000000000 +0100
</span><span class=gi></span><span class=gu>@@ -1,5 +1,6 @@
</span><span class=gu></span> message InfoResponse {
   repeated Label labels = 1 [(gogoproto.nullable) = false];
   int64 min_time        = 2;
   int64 max_time        = 3;
<span class=gi>+  string store_group_id = 4;
</span><span class=gi>+  enum PeerType {
</span><span class=gi>+    STORE  = 0;
</span><span class=gi>+    SOURCE = 1;
</span><span class=gi>+    QUERY  = 2;
</span><span class=gi>+  }
</span><span class=gi>+  PeerType peer_type    = 5;
</span><span class=gi></span> }
</code></pre></div><p>For the purpose of querying data from store instances, stores instance will be
grouped by:</p><ul><li>labels, as returned as part of <code>InfoResponse</code></li><li>the new <code>store_group_id</code> string identifier</li></ul><p>Therefore, stores having identical sets of labels and identical values for
<code>store_group_id</code> will belong in the same group for the purpose of querying
data. Stores having an empty <code>store_group_id</code> field and matching labels will be
considered to be part of the same group. Stores having an empty
<code>store_group_id</code> field and empty label sets will also be considered part of the
same group.</p><p>If a service implementing the store API (a &lsquo;store instance&rsquo;) has a <code>STORE</code> or
<code>QUERY</code> peer type, query instances will treat each store instance in the same
group as having access to the same data. Query instances will randomly pick any
two store instances<a href=https://www.eecs.harvard.edu/~michaelm/postscripts/mythesis.pdf>1</a> from the same group and use the first response
returned.</p><p>Otherwise, for the <code>SOURCE</code> peer type, query instances will wait for all
instances within the same group to respond (subject to existing timeouts)
before returning a response, consistent with the current behaviour. This is
necessary to collect all data available for the purposes of deduplication and
to fill gaps in data where an individual Prometheus server failed to ingest
data for a period of time.</p><p>Each service implementing the store API must determine what value the
<code>store_group_id</code> should return. For bucket stores, <code>store_group_id</code> should
contain the concatenation of the object store URL and bucket name. For all
other existing services implementing the store API, we will use an empty string
for <code>store_group_id</code> until a reason exists to use it.</p><p>Multiple buckets or object stores will be supported by setting the
<code>store_group_id</code>.</p><p>Existing instances running older versions of Thanos will be assumed to have
an empty string for <code>store_group_id</code> and a <code>SOURCE</code> peer type, which will
retain existing behaviour when awaiting responses.</p><h3 id=scope>Scope</h3><p>Horizontal scaling should be handled separately and is out of scope for this
proposal.</p><h2 id=user-experience>User experience</h2><p>From a user&rsquo;s point of view, query responses should be faster and more reliable:</p><ul><li><p>Running multiple bucket store instances will allow the query to be served even
if a single store instance fails.</p></li><li><p>Query latency should be lower since the response will be served from the
first bucket store instance to reply.</p></li></ul><p>The user experience for query responses involving only Thanos sidecars will be
unaffected.</p><h2 id=alternatives-considered>Alternatives considered</h2><h3 id=implicitly-relying-on-store-labels>Implicitly relying on store labels</h3><p>Rather than expanding the <code>InfoResponse</code> Protobuf, we had originally considered
relying on an empty set of store labels to determine that a store instance was
acting as a gateway.</p><p>We decided against this approach as it would make debugging harder due to its
implicit nature, and is likely to cause bugs in future.</p><h3 id=using-boolean-fields-to-determine-query-behaviour>Using boolean fields to determine query behaviour</h3><p>We rejected the idea of adding a <code>gateway</code> or <code>deduplicated</code> boolean field to
<code>InfoResponse</code> in the store RPC API. The value of these fields would have had
the same effect on query behaviour as returning the peer type field as proposed
above and would be more explicit, but were specific to this use case.</p><p>The peer type field in <code>InfoResponse</code> proposed above could be used for other
use cases aside from determining query behaviour.</p><h2 id=related-future-work>Related future work</h2><h3 id=sharing-data-between-store-instances>Sharing data between store instances</h3><p>Thanos bucket stores download index and metadata from the object store on
start-up. If multiple instances of a bucket store are used to provide high
availability, each instance will download the same files for its own use. These
file sizes can be in the order of gigabytes.</p><p>Ideally, the overhead of each store instance downloading its own data would be
avoided. We decided that it would be more appropriate to tackle sharing data as
part of future work to support the horizontal scaling of store instances.</p></div></div></div><footer class="bg-dark text-light"><div class="container text-center text-md-left"><div class="row py-5"><div class="col-12 col-md-6 col-lg mb-3 mb-lg-0"><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt=Thanos width=45%></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Documentation</h6><ul class=list-unstyled><li><a class=text-reset href=https://improbable-eng.github.io/thanos/getting-started.md>Getting Started</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/design.md>Design</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/storage.md>Storage</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/service-discovery.md>Service Discovery</a></li></ul></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://join.slack.com/t/improbable-eng/shared_invite/enQtMzQ1ODcyMzQ5MjM4LWY5ZWZmNGM2ODc5MmViNmQ3ZTA3ZTY3NzQwOTBlMTkzZmIxZTIxODk0OWU3YjZhNWVlNDU3MDlkZGViZjhkMjc class=text-reset><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/improbable-eng/thanos class=text-reset><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/ThanosMetrics class=text-reset><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col col-md-6 col-lg"><h6 class=font-weight-bold>About</h6><p>Thanos is an OSS licensed project as Apache License 2.0</p></div></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js integrity=sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-137374921-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>